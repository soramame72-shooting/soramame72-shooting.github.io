<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>東方風シューティングゲーム</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
    }
    canvas {
      display: block;
    }
    #startScreen, #endScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    button {
      padding: 10px 20px;
      font-size: 20px;
      margin-top: 20px;
    }
    @keyframes titleFadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    h1 {
      font-size: 50px;
      animation: titleFadeIn 2s ease-in-out;
    }
    #startScreen p, #endScreen p {
      font-size: 24px;
    }
    #startScreen button, #endScreen button {
      font-size: 24px;
    }
    #credit {
      font-size: 18px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="startScreen">
    <h1>東方風シューティング</h1>
    <p>スペースキーで弾を撃てます！</p>
    <button onclick="startGame()">ゲーム開始</button>
    <div id="credit">
      <p>キャラクター立ち絵: <a href="https://twitter.com/_Hoshi_Ringo_" target="_blank">https://twitter.com/_Hoshi_Ringo_</a></p>
    </div>
  </div>

  <div id="endScreen" style="display:none;">
    <h1 id="endMessage"></h1>
    <p>スコア: <span id="finalScore"></span></p>
    <p>ハイスコア: <span id="highScore"></span></p>
    <button onclick="restartGame()">リトライ</button>
  </div>

  <script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let gameRunning = false;
let bullets = [], bossBullets = [], enemies = [];
let rewardMessage = '';
let highScore = localStorage.getItem('touhouHighScore') || 0;

// プレイヤー
const player = {
  x: canvas.width / 2,
  y: canvas.height - 100,
  width: 40,
  height: 40,
  hp: 100,
  score: 0,
  shield: false,
  image: new Image(),
};
player.image.src = 'player.png'; // プレイヤーの画像

// ボス
const boss = {
  x: canvas.width / 2 - 50,
  y: 100,
  width: 100,
  height: 100,
  hp: 10000,  // 体力を10000に変更
  maxHp: 10000,
  attackTimer: 0,
  attackInterval: 60,
  attackPattern: '',
  spellActive: false,
  image: new Image(),
};
boss.image.src = 'boss.png'; // ボスの画像

let keys = {};
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

// 弾クラス
class Bullet {
  constructor(x, y, speed, angle, fromBoss = false, isLarge = false) {
    this.x = x;
    this.y = y;
    this.speed = speed;
    this.angle = angle;
    this.fromBoss = fromBoss;
    this.isLarge = isLarge; // 大きさを管理
  }
  update() {
    this.x += Math.cos(this.angle) * this.speed;
    this.y += Math.sin(this.angle) * this.speed;
  }
  draw() {
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.isLarge ? 10 : 5, 0, Math.PI * 2); // 大きさを変更
    ctx.fillStyle = this.fromBoss ? 'red' : 'cyan';
    ctx.fill();
  }
}

// 雑魚敵クラス
class Enemy {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.width = 30;  // サイズを大きくしました
    this.height = 30; // サイズを大きくしました
    this.hp = 30;
    this.speed = 2 + Math.random() * 1;
    this.image = new Image();
    this.image.src = 'enemy.png'; // 敵の画像
  }
  update() {
    // 敵をランダムに動かす
    this.x += Math.random() * 2 - 1; // 横方向にランダムに動く
    this.y += this.speed; // 縦方向に進む
  }
  draw() {
    ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
  }
}

// スペルカード演出（背景点滅）
function drawSpellEffect() {
  if (boss.spellActive) {
    ctx.fillStyle = 'rgba(255, 0, 255, 0.1)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
}

// プレイヤー移動＆攻撃
function updatePlayer() {
  if (keys['ArrowUp'] || keys['w']) player.y -= 5;
  if (keys['ArrowDown'] || keys['s']) player.y += 5;
  if (keys['ArrowLeft'] || keys['a']) player.x -= 5;
  if (keys['ArrowRight'] || keys['d']) player.x += 5;

  player.x = Math.max(0, Math.min(player.x, canvas.width - player.width));
  player.y = Math.max(0, Math.min(player.y, canvas.height - player.height));

  if (keys[' '] && gameRunning) {
    if (Math.random() > 0.1) { // 発射頻度を落とす
      bullets.push(new Bullet(player.x + player.width / 2, player.y, 6, -Math.PI / 2));
    }
  }
}

// ボス攻撃パターン
function updateBoss() {
  boss.attackTimer++;
  if (boss.attackTimer >= boss.attackInterval) {
    boss.attackTimer = 0;
    boss.spellActive = Math.random() < 0.3;
    fireCircleBullets();
  }

  // ボスの動き（大胆に動くように変更）
  boss.x += Math.random() * 20 - 10; // 横方向により大きくランダムに動かす
  boss.y += Math.random() * 10 - 5; // 縦方向にも大胆に動かす
  // ボスがプレイヤーを追いかける動き
  if (player.x > boss.x) boss.x += 1;
  if (player.x < boss.x) boss.x -= 1;
  if (player.y > boss.y) boss.y += 1;
  if (player.y < boss.y) boss.y -= 1;
}

// ボス弾
function fireCircleBullets() {
  const count = boss.spellActive ? 24 : 12;
  for (let i = 0; i < count; i++) {
    let angle = (Math.PI * 2 * i) / count;
    // 赤い弾の大きさをランダムで変える
    const isLarge = Math.random() < 0.1; // 10%の確率で大きい弾
    bossBullets.push(new Bullet(boss.x + boss.width/2, boss.y + boss.height, 2 + Math.random()*2, angle, true, isLarge));
  }
}

// 敵出現
function spawnEnemy() {
  if (Math.random() < 0.02) {
    let x = Math.random() * (canvas.width - 30);
    enemies.push(new Enemy(x, -30));
  }
}

// 敵・弾・当たり判定など
function checkCollisions() {
  bullets.forEach((b, i) => {
    // 雑魚
    enemies.forEach((e, j) => {
      if (b.x > e.x && b.x < e.x + e.width && b.y > e.y && b.y < e.y + e.height) {
        enemies.splice(j, 1);
        bullets.splice(i, 1);
        player.score += 100;
      }
    });

    // ボス
    if (b.x > boss.x && b.x < boss.x + boss.width && b.y > boss.y && b.y < boss.y + boss.height) {
      boss.hp -= 1;  // 弾のダメージを1に設定
      bullets.splice(i, 1);
    }
  });

  bossBullets.forEach((b, i) => {
    if (b.x > player.x && b.x < player.x + player.width &&
        b.y > player.y && b.y < player.y + player.height) {
      if (!player.shield) player.hp -= 10;
      bossBullets.splice(i, 1);
    }
  });

  enemies.forEach((e, i) => {
    if (e.x < player.x + player.width && e.x + e.width > player.x &&
        e.y < player.y + player.height && e.y + e.height > player.y) {
      if (!player.shield) player.hp -= 20;
      enemies.splice(i, 1);
    }
  });
}

// ボスHPバーの描画（赤色のグラデーション）
function drawBossHp() {
  let grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
  grad.addColorStop(0, '#ff0000'); // 赤
  grad.addColorStop(1, '#ff7f7f'); // 薄い赤

  ctx.fillStyle = 'black';
  ctx.fillRect(0, 10, canvas.width, 10);  // ボスHPバーの上に少し隙間を開ける

  ctx.fillStyle = grad;
  ctx.fillRect(0, 10, canvas.width * (boss.hp / boss.maxHp), 10);  // ボスHPに応じた長さ
}

// ボス名表示
function drawBossName() {
  ctx.fillStyle = 'white';
  ctx.font = '30px Arial';
  ctx.fillText('フランドール・スカーレット', canvas.width / 2 - 150, 40); // HPバーの上に名前を表示
}

// 背景
function drawBackground() {
  let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
  grad.addColorStop(0, '#222244');
  grad.addColorStop(1, '#000000');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

// メインループ
function update() {
  if (!gameRunning) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBackground();
  drawSpellEffect();

  drawBossName(); // ボス名を描画

  updatePlayer();
  ctx.drawImage(player.image, player.x, player.y, player.width, player.height);

  bullets.forEach(b => { b.update(); b.draw(); });
  bossBullets.forEach(b => { b.update(); b.draw(); });

  updateBoss();
  ctx.drawImage(boss.image, boss.x, boss.y, boss.width, boss.height);
  drawBossHp();  // HPバーを上部に描画

  spawnEnemy();
  enemies.forEach(e => { e.update(); e.draw(); });

  checkCollisions();

  ctx.fillStyle = 'white';
  ctx.font = '30px Arial';
  ctx.fillText(`HP: ${player.hp}`, 20, 30);
  ctx.fillText(`Score: ${player.score}`, 20, 60);

  if (player.hp <= 0) endGame(false);
  if (boss.hp <= 0) endGame(true);

  requestAnimationFrame(update);
}

// ゲーム開始＆リトライ
function startGame() {
  document.getElementById('startScreen').style.display = 'none';
  gameRunning = true;
  update();
}

function restartGame() {
  location.reload();
}

// ゲーム終了
function endGame(cleared) {
  gameRunning = false;
  document.getElementById('endScreen').style.display = 'flex';
  document.getElementById('endMessage').textContent = cleared ? 'ゲームクリア！' : 'ゲームオーバー';
  document.getElementById('finalScore').textContent = player.score;

  // ハイスコア更新
  if (player.score > highScore) {
    highScore = player.score;
    localStorage.setItem('touhouHighScore', highScore);
  }
  document.getElementById('highScore').textContent = highScore;
}
</script>
</body>
</html>
